pipeline {
  agent any

  environment {
    DOCKERHUB = "PJyothiraditya9"
    BACKEND_IMAGE = "${DOCKERHUB}/blog_app-backend"
    FRONTEND_IMAGE = "${DOCKERHUB}/blog_app-frontend"
    DOCKER_CREDS = credentials('dockerhub-creds')
    SLACK_WEBHOOK = credentials('slack-webhook')   // ✅ new line
    SONAR_TOKEN = credentials('sonar-token')
  }

  stages {
    stage('Checkout') {
        steps {
            git branch: 'main', url: 'https://github.com/your/repo.git'
        }
    }

    stage('Code Quality - SonarQube') {
        steps {
            withSonarQubeEnv('My-Sonar-Server') {
                sh "sonar-scanner \
                    -Dsonar.projectKey=blog-app \
                    -Dsonar.sources=. \
                    -Dsonar.host.url=http://localhost:9000 \
                    -Dsonar.login=${SONAR_TOKEN}"
            }
        }
    }

    stage('Build Backend Image') {
      steps {
        dir('server') {
          sh "docker build -t ${BACKEND_IMAGE}:${BUILD_NUMBER} ."
        }
      }
    }

    stage('Build Frontend Image') {
      steps {
        dir('client') {
          sh "docker build -t ${FRONTEND_IMAGE}:${BUILD_NUMBER} ."
        }
      }
    }

    stage('Docker Login') {
      steps {
        // DOCKER_CREDS_USR and DOCKER_CREDS_PSW are created by credentials(...) usage
        sh "echo ${DOCKER_CREDS_PSW} | docker login -u ${DOCKER_CREDS_USR} --password-stdin"
      }
    }

    stage('Push Images') {
      steps {
        sh "docker push ${BACKEND_IMAGE}:${BUILD_NUMBER}"
        sh "docker push ${FRONTEND_IMAGE}:${BUILD_NUMBER}"
      }
    }

    stage('Deploy via Helm') {
        steps {
            script {
            sh """
                # set tags in values at deploy time (override)
                helm upgrade --install blog-app helm/blog-app \
                --namespace default \
                -f helm/blog-app/values-dev.yaml \
                --set image.backend.tag=${BUILD_NUMBER} \
                --set image.frontend.tag=${BUILD_NUMBER}
                # wait for rollouts
                kubectl rollout status deployment/blog-app-backend --timeout=120s || true
                kubectl rollout status deployment/blog-app-frontend --timeout=120s || true
            """
            }
        }
    }

  }

  post {
    success {
        script {
            def msg = "✅ *Build #${BUILD_NUMBER} Succeeded!* \nRepo: ${env.JOB_NAME} \nTag: ${BUILD_NUMBER}"
            sh """
                curl -X POST -H 'Content-type: application/json' \
                --data '{"text": "${msg}"}' \
                ${SLACK_WEBHOOK}
            """
        }
    }

    failure {
        script {
            def msg = "❌ *Build #${BUILD_NUMBER} Failed!* \nRepo: ${env.JOB_NAME}"
            sh """
                curl -X POST -H 'Content-type: application/json' \
                --data '{"text": "${msg}"}' \
                ${SLACK_WEBHOOK}
            """
        }
    }
}
}
