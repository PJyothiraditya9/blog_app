pipeline {
  agent any

  environment {
    DOCKERHUB = "PJyothiraditya9"                    // DockerHub username
    BACKEND_IMAGE = "${DOCKERHUB}/blog_app-backend"
    FRONTEND_IMAGE = "${DOCKERHUB}/blog_app-frontend"
    // credentials id must match the one you added in Jenkins
    DOCKER_CREDS = credentials('dockerhub-creds')    // username/password binding
  }

  stages {
    stage('Checkout') {
        steps {
            git branch: 'main', url: 'https://github.com/your/repo.git'
        }
    }

    stage('Build Backend Image') {
      steps {
        dir('server') {
          sh "docker build -t ${BACKEND_IMAGE}:${BUILD_NUMBER} ."
        }
      }
    }

    stage('Build Frontend Image') {
      steps {
        dir('client') {
          sh "docker build -t ${FRONTEND_IMAGE}:${BUILD_NUMBER} ."
        }
      }
    }

    stage('Docker Login') {
      steps {
        // DOCKER_CREDS_USR and DOCKER_CREDS_PSW are created by credentials(...) usage
        sh "echo ${DOCKER_CREDS_PSW} | docker login -u ${DOCKER_CREDS_USR} --password-stdin"
      }
    }

    stage('Push Images') {
      steps {
        sh "docker push ${BACKEND_IMAGE}:${BUILD_NUMBER}"
        sh "docker push ${FRONTEND_IMAGE}:${BUILD_NUMBER}"
      }
    }

    stage('Update K8s Manifests & Deploy') {
      steps {
        script {
          // Replace the image entries in the k8s deployment files to the new tags.
          // sed commands work on Linux; on Windows Jenkins agent shell use different tools
          sh """
            # update backend deployment
            sed -i 's|image: .*blog_app-backend.*|image: ${BACKEND_IMAGE}:${BUILD_NUMBER}|g' k8s/backend-deployment.yaml || true
            # update frontend deployment
            sed -i 's|image: .*blog_app-frontend.*|image: ${FRONTEND_IMAGE}:${BUILD_NUMBER}|g' k8s/frontend-deployment.yaml || true
            # apply all manifests
            kubectl apply -f k8s/
            kubectl rollout status deployment/backend-deployment --timeout=120s || true
            kubectl rollout status deployment/frontend-deployment --timeout=120s || true
          """
        }
      }
    }
  }

  post {
    always {
      // keep workspace clean
      sh 'docker system prune -f || true'
    }
    failure {
      mail to: '21bd1a665kcsmc@gmail.com', subject: "Jenkins: Build #${BUILD_NUMBER} failed", body: "Check Jenkins console for details."
    }
  }
}
